"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const s3_presigned_post_1 = require("@aws-sdk/s3-presigned-post");
// AWS S3 client
const s3 = new client_s3_1.S3Client({ region: process.env.AWS_REGION });
const ALLOWED_IMAGE_TYPES = ["image/jpeg", "image/png", "image/jpg"];
const MAX_FILE_SIZE_MB = 5;
const handler = async (event) => {
    try {
        const body = JSON.parse(event.body || "{}");
        const fileType = body.fileType;
        const userId = body.userId;
        if (!userId) {
            return {
                statusCode: 400,
                body: JSON.stringify({ message: "Missing userId parameter" }),
            };
        }
        if (!fileType || !ALLOWED_IMAGE_TYPES.includes(fileType)) {
            return {
                statusCode: 400,
                body: JSON.stringify({ message: "Invalid or unsupported file type" }),
            };
        }
        // Extract extension
        const fileExtension = fileType.split("/")[1].replace(/\+.*$/, "");
        // FINAL STANDARDIZED STORAGE PATH
        const fileKey = `visitor-images/${userId}/profile.${fileExtension}`;
        const presignedPost = await (0, s3_presigned_post_1.createPresignedPost)(s3, {
            Bucket: process.env.BUCKET_NAME,
            Key: fileKey,
            Fields: { "Content-Type": fileType },
            Conditions: [
                ["content-length-range", 0, MAX_FILE_SIZE_MB * 1024 * 1024],
                ["starts-with", "$Content-Type", fileType],
            ],
            Expires: 300, // 5 minutes
        });
        return {
            statusCode: 200,
            headers: {
                "Access-Control-Allow-Origin": "*",
            },
            body: JSON.stringify({
                url: presignedPost.url,
                fields: presignedPost.fields,
                fileKey,
                userId,
                expiresIn: 300,
            }),
        };
    }
    catch (error) {
        console.error("Error generating presigned POST URL:", error);
        return {
            statusCode: 500,
            body: JSON.stringify({ message: "Internal server error" }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVQcmVzaWduZWRVcGxvYWRVcmwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnZW5lcmF0ZVByZXNpZ25lZFVwbG9hZFVybC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxrREFBOEM7QUFDOUMsa0VBQWlFO0FBRWpFLGdCQUFnQjtBQUNoQixNQUFNLEVBQUUsR0FBRyxJQUFJLG9CQUFRLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO0FBRTVELE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxZQUFZLEVBQUUsV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBQ3JFLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDO0FBRXBCLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxLQUFVLEVBQUUsRUFBRTtJQUMxQyxJQUFJLENBQUM7UUFDSCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLENBQUM7UUFDNUMsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUMvQixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBRTNCLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNaLE9BQU87Z0JBQ0wsVUFBVSxFQUFFLEdBQUc7Z0JBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsQ0FBQzthQUM5RCxDQUFDO1FBQ0osQ0FBQztRQUVELElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztZQUN6RCxPQUFPO2dCQUNMLFVBQVUsRUFBRSxHQUFHO2dCQUNmLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsT0FBTyxFQUFFLGtDQUFrQyxFQUFFLENBQUM7YUFDdEUsQ0FBQztRQUNKLENBQUM7UUFFRCxvQkFBb0I7UUFDcEIsTUFBTSxhQUFhLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWxFLGtDQUFrQztRQUN0QyxNQUFNLE9BQU8sR0FBRyxrQkFBa0IsTUFBTSxZQUFZLGFBQWEsRUFBRSxDQUFDO1FBRWhFLE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBQSx1Q0FBbUIsRUFBQyxFQUFFLEVBQUU7WUFDbEQsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBWTtZQUNoQyxHQUFHLEVBQUUsT0FBTztZQUNaLE1BQU0sRUFBRSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUU7WUFDcEMsVUFBVSxFQUFFO2dCQUNWLENBQUMsc0JBQXNCLEVBQUUsQ0FBQyxFQUFFLGdCQUFnQixHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7Z0JBQzNELENBQUMsYUFBYSxFQUFFLGVBQWUsRUFBRSxRQUFRLENBQUM7YUFDM0M7WUFDRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFlBQVk7U0FDM0IsQ0FBQyxDQUFDO1FBRUgsT0FBTztZQUNMLFVBQVUsRUFBRSxHQUFHO1lBQ2YsT0FBTyxFQUFFO2dCQUNQLDZCQUE2QixFQUFFLEdBQUc7YUFDbkM7WUFDRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQztnQkFDbkIsR0FBRyxFQUFFLGFBQWEsQ0FBQyxHQUFHO2dCQUN0QixNQUFNLEVBQUUsYUFBYSxDQUFDLE1BQU07Z0JBQzVCLE9BQU87Z0JBQ1AsTUFBTTtnQkFDTixTQUFTLEVBQUUsR0FBRzthQUNmLENBQUM7U0FDSCxDQUFDO0lBQ0osQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLHNDQUFzQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzdELE9BQU87WUFDTCxVQUFVLEVBQUUsR0FBRztZQUNmLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLENBQUM7U0FDM0QsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDLENBQUM7QUF6RFcsUUFBQSxPQUFPLFdBeURsQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFMzQ2xpZW50IH0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1zM1wiO1xyXG5pbXBvcnQgeyBjcmVhdGVQcmVzaWduZWRQb3N0IH0gZnJvbSBcIkBhd3Mtc2RrL3MzLXByZXNpZ25lZC1wb3N0XCI7XHJcblxyXG4vLyBBV1MgUzMgY2xpZW50XHJcbmNvbnN0IHMzID0gbmV3IFMzQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIH0pO1xyXG5cclxuY29uc3QgQUxMT1dFRF9JTUFHRV9UWVBFUyA9IFtcImltYWdlL2pwZWdcIiwgXCJpbWFnZS9wbmdcIiwgXCJpbWFnZS9qcGdcIl07XHJcbmNvbnN0IE1BWF9GSUxFX1NJWkVfTUIgPSA1O1xyXG5cclxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IGFueSkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBib2R5ID0gSlNPTi5wYXJzZShldmVudC5ib2R5IHx8IFwie31cIik7XHJcbiAgICBjb25zdCBmaWxlVHlwZSA9IGJvZHkuZmlsZVR5cGU7XHJcbiAgICBjb25zdCB1c2VySWQgPSBib2R5LnVzZXJJZDsgXHJcblxyXG4gICAgaWYgKCF1c2VySWQpIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXHJcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBcIk1pc3NpbmcgdXNlcklkIHBhcmFtZXRlclwiIH0pLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghZmlsZVR5cGUgfHwgIUFMTE9XRURfSU1BR0VfVFlQRVMuaW5jbHVkZXMoZmlsZVR5cGUpKSB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxyXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogXCJJbnZhbGlkIG9yIHVuc3VwcG9ydGVkIGZpbGUgdHlwZVwiIH0pLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEV4dHJhY3QgZXh0ZW5zaW9uXHJcbiAgICBjb25zdCBmaWxlRXh0ZW5zaW9uID0gZmlsZVR5cGUuc3BsaXQoXCIvXCIpWzFdLnJlcGxhY2UoL1xcKy4qJC8sIFwiXCIpO1xyXG5cclxuICAgIC8vIEZJTkFMIFNUQU5EQVJESVpFRCBTVE9SQUdFIFBBVEhcclxuY29uc3QgZmlsZUtleSA9IGB2aXNpdG9yLWltYWdlcy8ke3VzZXJJZH0vcHJvZmlsZS4ke2ZpbGVFeHRlbnNpb259YDtcclxuXHJcbiAgICBjb25zdCBwcmVzaWduZWRQb3N0ID0gYXdhaXQgY3JlYXRlUHJlc2lnbmVkUG9zdChzMywge1xyXG4gICAgICBCdWNrZXQ6IHByb2Nlc3MuZW52LkJVQ0tFVF9OQU1FISxcclxuICAgICAgS2V5OiBmaWxlS2V5LFxyXG4gICAgICBGaWVsZHM6IHsgXCJDb250ZW50LVR5cGVcIjogZmlsZVR5cGUgfSxcclxuICAgICAgQ29uZGl0aW9uczogW1xyXG4gICAgICAgIFtcImNvbnRlbnQtbGVuZ3RoLXJhbmdlXCIsIDAsIE1BWF9GSUxFX1NJWkVfTUIgKiAxMDI0ICogMTAyNF0sXHJcbiAgICAgICAgW1wic3RhcnRzLXdpdGhcIiwgXCIkQ29udGVudC1UeXBlXCIsIGZpbGVUeXBlXSxcclxuICAgICAgXSxcclxuICAgICAgRXhwaXJlczogMzAwLCAvLyA1IG1pbnV0ZXNcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcclxuICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luXCI6IFwiKlwiLFxyXG4gICAgICB9LFxyXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgdXJsOiBwcmVzaWduZWRQb3N0LnVybCxcclxuICAgICAgICBmaWVsZHM6IHByZXNpZ25lZFBvc3QuZmllbGRzLFxyXG4gICAgICAgIGZpbGVLZXksXHJcbiAgICAgICAgdXNlcklkLFxyXG4gICAgICAgIGV4cGlyZXNJbjogMzAwLFxyXG4gICAgICB9KSxcclxuICAgIH07XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBnZW5lcmF0aW5nIHByZXNpZ25lZCBQT1NUIFVSTDpcIiwgZXJyb3IpO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3RhdHVzQ29kZTogNTAwLFxyXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6IFwiSW50ZXJuYWwgc2VydmVyIGVycm9yXCIgfSksXHJcbiAgICB9O1xyXG4gIH1cclxufTsiXX0=