"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_cognito_identity_provider_1 = require("@aws-sdk/client-cognito-identity-provider");
const client = new client_cognito_identity_provider_1.CognitoIdentityProviderClient({});
const USER_POOL_ID = process.env.USER_POOL_ID;
const ALLOWED_ROLES = ["newhire", "visitor"];
const handler = async (event) => {
    try {
        // 1) Get user from Cognito authorizer
        const claims = event.requestContext.authorizer?.claims;
        const username = claims?.sub; // Cognito username/subject
        if (!username) {
            return {
                statusCode: 401,
                body: JSON.stringify({ message: "Not authenticated" }),
            };
        }
        // 2) Read requestedRole from JSON body
        if (!event.body) {
            return {
                statusCode: 400,
                body: JSON.stringify({ message: "Missing body" }),
            };
        }
        let parsed;
        try {
            parsed = JSON.parse(event.body);
        }
        catch {
            return {
                statusCode: 400,
                body: JSON.stringify({ message: "Invalid JSON body" }),
            };
        }
        const requestedRole = parsed.requestedRole;
        if (!requestedRole || !ALLOWED_ROLES.includes(requestedRole)) {
            return {
                statusCode: 400,
                body: JSON.stringify({
                    message: "requestedRole must be 'newhire' or 'visitor'",
                }),
            };
        }
        // 3) Remove user from any existing newhire/visitor group
        const groupsResp = await client.send(new client_cognito_identity_provider_1.AdminListGroupsForUserCommand({
            UserPoolId: USER_POOL_ID,
            Username: username,
        }));
        const currentGroups = (groupsResp.Groups || []).map((g) => g.GroupName);
        for (const gName of currentGroups) {
            if (gName && ALLOWED_ROLES.includes(gName)) {
                await client.send(new client_cognito_identity_provider_1.AdminRemoveUserFromGroupCommand({
                    UserPoolId: USER_POOL_ID,
                    Username: username,
                    GroupName: gName,
                }));
            }
        }
        // 4) Add user to the requested group
        await client.send(new client_cognito_identity_provider_1.AdminAddUserToGroupCommand({
            UserPoolId: USER_POOL_ID,
            Username: username,
            GroupName: requestedRole,
        }));
        return {
            statusCode: 200,
            body: JSON.stringify({
                message: `Role updated to ${requestedRole}`,
            }),
        };
    }
    catch (err) {
        console.error("Error in set-role:", err);
        return {
            statusCode: 500,
            body: JSON.stringify({
                message: "Internal error",
                error: err?.message,
            }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0LXJvbGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXQtcm9sZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFJQSxnR0FLbUQ7QUFFbkQsTUFBTSxNQUFNLEdBQUcsSUFBSSxnRUFBNkIsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVyRCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQWEsQ0FBQztBQUMvQyxNQUFNLGFBQWEsR0FBRyxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQVUsQ0FBQztBQU8vQyxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQzFCLEtBQTJCLEVBQ0ssRUFBRTtJQUNsQyxJQUFJLENBQUM7UUFDSCxzQ0FBc0M7UUFDdEMsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQyxVQUFVLEVBQUUsTUFBYSxDQUFDO1FBQzlELE1BQU0sUUFBUSxHQUFHLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQywyQkFBMkI7UUFFekQsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2QsT0FBTztnQkFDTCxVQUFVLEVBQUUsR0FBRztnQkFDZixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxDQUFDO2FBQ3ZELENBQUM7UUFDSixDQUFDO1FBRUQsdUNBQXVDO1FBQ3ZDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDaEIsT0FBTztnQkFDTCxVQUFVLEVBQUUsR0FBRztnQkFDZixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsQ0FBQzthQUNsRCxDQUFDO1FBQ0osQ0FBQztRQUVELElBQUksTUFBaUIsQ0FBQztRQUN0QixJQUFJLENBQUM7WUFDSCxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEMsQ0FBQztRQUFDLE1BQU0sQ0FBQztZQUNQLE9BQU87Z0JBQ0wsVUFBVSxFQUFFLEdBQUc7Z0JBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQzthQUN2RCxDQUFDO1FBQ0osQ0FBQztRQUVELE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxhQUFtQyxDQUFDO1FBRWpFLElBQUksQ0FBQyxhQUFhLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLGFBQTRCLENBQUMsRUFBRSxDQUFDO1lBQzVFLE9BQU87Z0JBQ0wsVUFBVSxFQUFFLEdBQUc7Z0JBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7b0JBQ25CLE9BQU8sRUFBRSw4Q0FBOEM7aUJBQ3hELENBQUM7YUFDSCxDQUFDO1FBQ0osQ0FBQztRQUVELHlEQUF5RDtRQUN6RCxNQUFNLFVBQVUsR0FBRyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQ2xDLElBQUksZ0VBQTZCLENBQUM7WUFDaEMsVUFBVSxFQUFFLFlBQVk7WUFDeEIsUUFBUSxFQUFFLFFBQVE7U0FDbkIsQ0FBQyxDQUNILENBQUM7UUFFRixNQUFNLGFBQWEsR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFeEUsS0FBSyxNQUFNLEtBQUssSUFBSSxhQUFhLEVBQUUsQ0FBQztZQUNsQyxJQUFJLEtBQUssSUFBSSxhQUFhLENBQUMsUUFBUSxDQUFDLEtBQW9CLENBQUMsRUFBRSxDQUFDO2dCQUMxRCxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQ2YsSUFBSSxrRUFBK0IsQ0FBQztvQkFDbEMsVUFBVSxFQUFFLFlBQVk7b0JBQ3hCLFFBQVEsRUFBRSxRQUFRO29CQUNsQixTQUFTLEVBQUUsS0FBSztpQkFDakIsQ0FBQyxDQUNILENBQUM7WUFDSixDQUFDO1FBQ0gsQ0FBQztRQUVELHFDQUFxQztRQUNyQyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQ2YsSUFBSSw2REFBMEIsQ0FBQztZQUM3QixVQUFVLEVBQUUsWUFBWTtZQUN4QixRQUFRLEVBQUUsUUFBUTtZQUNsQixTQUFTLEVBQUUsYUFBYTtTQUN6QixDQUFDLENBQ0gsQ0FBQztRQUVGLE9BQU87WUFDTCxVQUFVLEVBQUUsR0FBRztZQUNmLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUNuQixPQUFPLEVBQUUsbUJBQW1CLGFBQWEsRUFBRTthQUM1QyxDQUFDO1NBQ0gsQ0FBQztJQUNKLENBQUM7SUFBQyxPQUFPLEdBQVEsRUFBRSxDQUFDO1FBQ2xCLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDekMsT0FBTztZQUNMLFVBQVUsRUFBRSxHQUFHO1lBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ25CLE9BQU8sRUFBRSxnQkFBZ0I7Z0JBQ3pCLEtBQUssRUFBRSxHQUFHLEVBQUUsT0FBTzthQUNwQixDQUFDO1NBQ0gsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDLENBQUM7QUEzRlcsUUFBQSxPQUFPLFdBMkZsQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgQVBJR2F0ZXdheVByb3h5RXZlbnQsXHJcbiAgQVBJR2F0ZXdheVByb3h5UmVzdWx0LFxyXG59IGZyb20gXCJhd3MtbGFtYmRhXCI7XHJcbmltcG9ydCB7XHJcbiAgQ29nbml0b0lkZW50aXR5UHJvdmlkZXJDbGllbnQsXHJcbiAgQWRtaW5BZGRVc2VyVG9Hcm91cENvbW1hbmQsXHJcbiAgQWRtaW5MaXN0R3JvdXBzRm9yVXNlckNvbW1hbmQsXHJcbiAgQWRtaW5SZW1vdmVVc2VyRnJvbUdyb3VwQ29tbWFuZCxcclxufSBmcm9tIFwiQGF3cy1zZGsvY2xpZW50LWNvZ25pdG8taWRlbnRpdHktcHJvdmlkZXJcIjtcclxuXHJcbmNvbnN0IGNsaWVudCA9IG5ldyBDb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudCh7fSk7XHJcblxyXG5jb25zdCBVU0VSX1BPT0xfSUQgPSBwcm9jZXNzLmVudi5VU0VSX1BPT0xfSUQhO1xyXG5jb25zdCBBTExPV0VEX1JPTEVTID0gW1wibmV3aGlyZVwiLCBcInZpc2l0b3JcIl0gYXMgY29uc3Q7XHJcbnR5cGUgQWxsb3dlZFJvbGUgPSAodHlwZW9mIEFMTE9XRURfUk9MRVMpW251bWJlcl07XHJcblxyXG5pbnRlcmZhY2UgQm9keVNoYXBlIHtcclxuICByZXF1ZXN0ZWRSb2xlPzogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcclxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRcclxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcclxuICB0cnkge1xyXG4gICAgLy8gMSkgR2V0IHVzZXIgZnJvbSBDb2duaXRvIGF1dGhvcml6ZXJcclxuICAgIGNvbnN0IGNsYWltcyA9IGV2ZW50LnJlcXVlc3RDb250ZXh0LmF1dGhvcml6ZXI/LmNsYWltcyBhcyBhbnk7XHJcbiAgICBjb25zdCB1c2VybmFtZSA9IGNsYWltcz8uc3ViOyAvLyBDb2duaXRvIHVzZXJuYW1lL3N1YmplY3RcclxuXHJcbiAgICBpZiAoIXVzZXJuYW1lKSB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgc3RhdHVzQ29kZTogNDAxLFxyXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogXCJOb3QgYXV0aGVudGljYXRlZFwiIH0pLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIDIpIFJlYWQgcmVxdWVzdGVkUm9sZSBmcm9tIEpTT04gYm9keVxyXG4gICAgaWYgKCFldmVudC5ib2R5KSB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxyXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogXCJNaXNzaW5nIGJvZHlcIiB9KSxcclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcGFyc2VkOiBCb2R5U2hhcGU7XHJcbiAgICB0cnkge1xyXG4gICAgICBwYXJzZWQgPSBKU09OLnBhcnNlKGV2ZW50LmJvZHkpO1xyXG4gICAgfSBjYXRjaCB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxyXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogXCJJbnZhbGlkIEpTT04gYm9keVwiIH0pLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHJlcXVlc3RlZFJvbGUgPSBwYXJzZWQucmVxdWVzdGVkUm9sZSBhcyBzdHJpbmcgfCB1bmRlZmluZWQ7XHJcblxyXG4gICAgaWYgKCFyZXF1ZXN0ZWRSb2xlIHx8ICFBTExPV0VEX1JPTEVTLmluY2x1ZGVzKHJlcXVlc3RlZFJvbGUgYXMgQWxsb3dlZFJvbGUpKSB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxyXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICAgIG1lc3NhZ2U6IFwicmVxdWVzdGVkUm9sZSBtdXN0IGJlICduZXdoaXJlJyBvciAndmlzaXRvcidcIixcclxuICAgICAgICB9KSxcclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvLyAzKSBSZW1vdmUgdXNlciBmcm9tIGFueSBleGlzdGluZyBuZXdoaXJlL3Zpc2l0b3IgZ3JvdXBcclxuICAgIGNvbnN0IGdyb3Vwc1Jlc3AgPSBhd2FpdCBjbGllbnQuc2VuZChcclxuICAgICAgbmV3IEFkbWluTGlzdEdyb3Vwc0ZvclVzZXJDb21tYW5kKHtcclxuICAgICAgICBVc2VyUG9vbElkOiBVU0VSX1BPT0xfSUQsXHJcbiAgICAgICAgVXNlcm5hbWU6IHVzZXJuYW1lLFxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCBjdXJyZW50R3JvdXBzID0gKGdyb3Vwc1Jlc3AuR3JvdXBzIHx8IFtdKS5tYXAoKGcpID0+IGcuR3JvdXBOYW1lKTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IGdOYW1lIG9mIGN1cnJlbnRHcm91cHMpIHtcclxuICAgICAgaWYgKGdOYW1lICYmIEFMTE9XRURfUk9MRVMuaW5jbHVkZXMoZ05hbWUgYXMgQWxsb3dlZFJvbGUpKSB7XHJcbiAgICAgICAgYXdhaXQgY2xpZW50LnNlbmQoXHJcbiAgICAgICAgICBuZXcgQWRtaW5SZW1vdmVVc2VyRnJvbUdyb3VwQ29tbWFuZCh7XHJcbiAgICAgICAgICAgIFVzZXJQb29sSWQ6IFVTRVJfUE9PTF9JRCxcclxuICAgICAgICAgICAgVXNlcm5hbWU6IHVzZXJuYW1lLFxyXG4gICAgICAgICAgICBHcm91cE5hbWU6IGdOYW1lLFxyXG4gICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gNCkgQWRkIHVzZXIgdG8gdGhlIHJlcXVlc3RlZCBncm91cFxyXG4gICAgYXdhaXQgY2xpZW50LnNlbmQoXHJcbiAgICAgIG5ldyBBZG1pbkFkZFVzZXJUb0dyb3VwQ29tbWFuZCh7XHJcbiAgICAgICAgVXNlclBvb2xJZDogVVNFUl9QT09MX0lELFxyXG4gICAgICAgIFVzZXJuYW1lOiB1c2VybmFtZSxcclxuICAgICAgICBHcm91cE5hbWU6IHJlcXVlc3RlZFJvbGUsXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcclxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICAgIG1lc3NhZ2U6IGBSb2xlIHVwZGF0ZWQgdG8gJHtyZXF1ZXN0ZWRSb2xlfWAsXHJcbiAgICAgIH0pLFxyXG4gICAgfTtcclxuICB9IGNhdGNoIChlcnI6IGFueSkge1xyXG4gICAgY29uc29sZS5lcnJvcihcIkVycm9yIGluIHNldC1yb2xlOlwiLCBlcnIpO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3RhdHVzQ29kZTogNTAwLFxyXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgbWVzc2FnZTogXCJJbnRlcm5hbCBlcnJvclwiLFxyXG4gICAgICAgIGVycm9yOiBlcnI/Lm1lc3NhZ2UsXHJcbiAgICAgIH0pLFxyXG4gICAgfTtcclxuICB9XHJcbn07XHJcbiJdfQ==