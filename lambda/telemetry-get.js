"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client = new client_dynamodb_1.DynamoDBClient({});
const ddb = lib_dynamodb_1.DynamoDBDocumentClient.from(client);
const TABLE = process.env.TELEMETRY_TABLE || "PiTelemetry";
/**
 * GET /telemetry?device=pi3-01&limit=25
 * Returns newest -> oldest items.
 */
const handler = async (event) => {
    try {
        const qs = event.queryStringParameters ?? {};
        const device = (qs.device ?? "pi3-01").toString();
        const limitRaw = Number(qs.limit ?? 25);
        const limit = Number.isFinite(limitRaw) ? Math.min(Math.max(limitRaw, 1), 200) : 25;
        const cmd = new lib_dynamodb_1.QueryCommand({
            TableName: TABLE,
            KeyConditionExpression: "#d = :dev",
            ExpressionAttributeNames: { "#d": "device" },
            ExpressionAttributeValues: { ":dev": device },
            ScanIndexForward: false, // newest first
            Limit: limit,
        });
        const { Items = [] } = await ddb.send(cmd);
        return {
            statusCode: 200,
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ device, count: Items.length, items: Items }),
        };
    }
    catch (err) {
        console.error("telemetry-get error:", err);
        return {
            statusCode: 500,
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ error: "Failed to query telemetry", details: String(err?.message ?? err) }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVsZW1ldHJ5LWdldC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRlbGVtZXRyeS1nZXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUE2RTtBQUU3RSxNQUFNLE1BQU0sR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDdEMsTUFBTSxHQUFHLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBRWhELE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxJQUFJLGFBQWEsQ0FBQztBQUUzRDs7O0dBR0c7QUFDSSxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBMkIsRUFBa0MsRUFBRTtJQUMzRixJQUFJLENBQUM7UUFDSCxNQUFNLEVBQUUsR0FBRyxLQUFLLENBQUMscUJBQXFCLElBQUksRUFBRSxDQUFDO1FBQzdDLE1BQU0sTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDLE1BQU0sSUFBSSxRQUFRLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNsRCxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsRUFBRSxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUMsQ0FBQztRQUN4QyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFFcEYsTUFBTSxHQUFHLEdBQUcsSUFBSSwyQkFBWSxDQUFDO1lBQzNCLFNBQVMsRUFBRSxLQUFLO1lBQ2hCLHNCQUFzQixFQUFFLFdBQVc7WUFDbkMsd0JBQXdCLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFO1lBQzVDLHlCQUF5QixFQUFFLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRTtZQUM3QyxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsZUFBZTtZQUN4QyxLQUFLLEVBQUUsS0FBSztTQUNiLENBQUMsQ0FBQztRQUVILE1BQU0sRUFBRSxLQUFLLEdBQUcsRUFBRSxFQUFFLEdBQUcsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRTNDLE9BQU87WUFDTCxVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU8sRUFBRSxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsRUFBRTtZQUMvQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUM7U0FDcEUsQ0FBQztJQUNKLENBQUM7SUFBQyxPQUFPLEdBQVEsRUFBRSxDQUFDO1FBQ2xCLE9BQU8sQ0FBQyxLQUFLLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDM0MsT0FBTztZQUNMLFVBQVUsRUFBRSxHQUFHO1lBQ2YsT0FBTyxFQUFFLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFO1lBQy9DLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxFQUFFLDJCQUEyQixFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsR0FBRyxFQUFFLE9BQU8sSUFBSSxHQUFHLENBQUMsRUFBRSxDQUFDO1NBQ25HLENBQUM7SUFDSixDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBL0JXLFFBQUEsT0FBTyxXQStCbEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQgfSBmcm9tIFwiYXdzLWxhbWJkYVwiO1xyXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gXCJAYXdzLXNkay9jbGllbnQtZHluYW1vZGJcIjtcclxuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgUXVlcnlDb21tYW5kIH0gZnJvbSBcIkBhd3Mtc2RrL2xpYi1keW5hbW9kYlwiO1xyXG5cclxuY29uc3QgY2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcclxuY29uc3QgZGRiID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGNsaWVudCk7XHJcblxyXG5jb25zdCBUQUJMRSA9IHByb2Nlc3MuZW52LlRFTEVNRVRSWV9UQUJMRSB8fCBcIlBpVGVsZW1ldHJ5XCI7XHJcblxyXG4vKipcclxuICogR0VUIC90ZWxlbWV0cnk/ZGV2aWNlPXBpMy0wMSZsaW1pdD0yNVxyXG4gKiBSZXR1cm5zIG5ld2VzdCAtPiBvbGRlc3QgaXRlbXMuXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBxcyA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyA/PyB7fTtcclxuICAgIGNvbnN0IGRldmljZSA9IChxcy5kZXZpY2UgPz8gXCJwaTMtMDFcIikudG9TdHJpbmcoKTtcclxuICAgIGNvbnN0IGxpbWl0UmF3ID0gTnVtYmVyKHFzLmxpbWl0ID8/IDI1KTtcclxuICAgIGNvbnN0IGxpbWl0ID0gTnVtYmVyLmlzRmluaXRlKGxpbWl0UmF3KSA/IE1hdGgubWluKE1hdGgubWF4KGxpbWl0UmF3LCAxKSwgMjAwKSA6IDI1O1xyXG5cclxuICAgIGNvbnN0IGNtZCA9IG5ldyBRdWVyeUNvbW1hbmQoe1xyXG4gICAgICBUYWJsZU5hbWU6IFRBQkxFLFxyXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiBcIiNkID0gOmRldlwiLFxyXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHsgXCIjZFwiOiBcImRldmljZVwiIH0sXHJcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHsgXCI6ZGV2XCI6IGRldmljZSB9LFxyXG4gICAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZSwgLy8gbmV3ZXN0IGZpcnN0XHJcbiAgICAgIExpbWl0OiBsaW1pdCxcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IHsgSXRlbXMgPSBbXSB9ID0gYXdhaXQgZGRiLnNlbmQoY21kKTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXHJcbiAgICAgIGhlYWRlcnM6IHsgXCJjb250ZW50LXR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIgfSxcclxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBkZXZpY2UsIGNvdW50OiBJdGVtcy5sZW5ndGgsIGl0ZW1zOiBJdGVtcyB9KSxcclxuICAgIH07XHJcbiAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCJ0ZWxlbWV0cnktZ2V0IGVycm9yOlwiLCBlcnIpO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3RhdHVzQ29kZTogNTAwLFxyXG4gICAgICBoZWFkZXJzOiB7IFwiY29udGVudC10eXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiIH0sXHJcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6IFwiRmFpbGVkIHRvIHF1ZXJ5IHRlbGVtZXRyeVwiLCBkZXRhaWxzOiBTdHJpbmcoZXJyPy5tZXNzYWdlID8/IGVycikgfSksXHJcbiAgICB9O1xyXG4gIH1cclxufTtcclxuIl19