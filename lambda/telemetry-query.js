"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client = new client_dynamodb_1.DynamoDBClient({});
const ddb = lib_dynamodb_1.DynamoDBDocumentClient.from(client);
const tableName = process.env.TELEMETRY_TABLE;
const handler = async (event) => {
    const device = event.queryStringParameters?.device;
    const limitStr = event.queryStringParameters?.limit;
    const limit = limitStr ? parseInt(limitStr, 10) : 25;
    if (!device) {
        return {
            statusCode: 400,
            body: JSON.stringify({ message: "Missing ?device=..." }),
        };
    }
    const cmd = new lib_dynamodb_1.QueryCommand({
        TableName: tableName,
        KeyConditionExpression: "#d = :device",
        ExpressionAttributeNames: { "#d": "device" },
        ExpressionAttributeValues: { ":device": device },
        ScanIndexForward: false, // newest first
        Limit: limit,
    });
    const result = await ddb.send(cmd);
    return {
        statusCode: 200,
        body: JSON.stringify({
            device,
            count: result.Count,
            items: result.Items ?? [],
        }),
        headers: { "Content-Type": "application/json" },
    };
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVsZW1ldHJ5LXF1ZXJ5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVsZW1ldHJ5LXF1ZXJ5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDhEQUEwRDtBQUMxRCx3REFBNkU7QUFFN0UsTUFBTSxNQUFNLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3RDLE1BQU0sR0FBRyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNoRCxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWdCLENBQUM7QUFFeEMsTUFBTSxPQUFPLEdBQTZCLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRTtJQUMvRCxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMscUJBQXFCLEVBQUUsTUFBTSxDQUFDO0lBQ25ELE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxxQkFBcUIsRUFBRSxLQUFLLENBQUM7SUFDcEQsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFFckQsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ1osT0FBTztZQUNMLFVBQVUsRUFBRSxHQUFHO1lBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsQ0FBQztTQUN6RCxDQUFDO0lBQ0osQ0FBQztJQUVELE1BQU0sR0FBRyxHQUFHLElBQUksMkJBQVksQ0FBQztRQUMzQixTQUFTLEVBQUUsU0FBUztRQUNwQixzQkFBc0IsRUFBRSxjQUFjO1FBQ3RDLHdCQUF3QixFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRTtRQUM1Qyx5QkFBeUIsRUFBRSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUU7UUFDaEQsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLGVBQWU7UUFDeEMsS0FBSyxFQUFFLEtBQUs7S0FDYixDQUFDLENBQUM7SUFFSCxNQUFNLE1BQU0sR0FBRyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFbkMsT0FBTztRQUNMLFVBQVUsRUFBRSxHQUFHO1FBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDbkIsTUFBTTtZQUNOLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSztZQUNuQixLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUssSUFBSSxFQUFFO1NBQzFCLENBQUM7UUFDRixPQUFPLEVBQUUsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUU7S0FDaEQsQ0FBQztBQUNKLENBQUMsQ0FBQztBQWhDVyxRQUFBLE9BQU8sV0FnQ2xCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5SGFuZGxlclYyIH0gZnJvbSBcImF3cy1sYW1iZGFcIjtcclxuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tIFwiQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiXCI7XHJcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFF1ZXJ5Q29tbWFuZCB9IGZyb20gXCJAYXdzLXNkay9saWItZHluYW1vZGJcIjtcclxuXHJcbmNvbnN0IGNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XHJcbmNvbnN0IGRkYiA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShjbGllbnQpO1xyXG5jb25zdCB0YWJsZU5hbWUgPSBwcm9jZXNzLmVudi5URUxFTUVUUllfVEFCTEUhO1xyXG5cclxuZXhwb3J0IGNvbnN0IGhhbmRsZXI6IEFQSUdhdGV3YXlQcm94eUhhbmRsZXJWMiA9IGFzeW5jIChldmVudCkgPT4ge1xyXG4gIGNvbnN0IGRldmljZSA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycz8uZGV2aWNlO1xyXG4gIGNvbnN0IGxpbWl0U3RyID0gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzPy5saW1pdDtcclxuICBjb25zdCBsaW1pdCA9IGxpbWl0U3RyID8gcGFyc2VJbnQobGltaXRTdHIsIDEwKSA6IDI1O1xyXG5cclxuICBpZiAoIWRldmljZSkge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3RhdHVzQ29kZTogNDAwLFxyXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6IFwiTWlzc2luZyA/ZGV2aWNlPS4uLlwiIH0pLFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGNvbnN0IGNtZCA9IG5ldyBRdWVyeUNvbW1hbmQoe1xyXG4gICAgVGFibGVOYW1lOiB0YWJsZU5hbWUsXHJcbiAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiBcIiNkID0gOmRldmljZVwiLFxyXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7IFwiI2RcIjogXCJkZXZpY2VcIiB9LFxyXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogeyBcIjpkZXZpY2VcIjogZGV2aWNlIH0sXHJcbiAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZSwgLy8gbmV3ZXN0IGZpcnN0XHJcbiAgICBMaW1pdDogbGltaXQsXHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRkYi5zZW5kKGNtZCk7XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBzdGF0dXNDb2RlOiAyMDAsXHJcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgIGRldmljZSxcclxuICAgICAgY291bnQ6IHJlc3VsdC5Db3VudCxcclxuICAgICAgaXRlbXM6IHJlc3VsdC5JdGVtcyA/PyBbXSxcclxuICAgIH0pLFxyXG4gICAgaGVhZGVyczogeyBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIiB9LFxyXG4gIH07XHJcbn07XHJcbiJdfQ==