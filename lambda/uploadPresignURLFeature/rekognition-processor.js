"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_rekognition_1 = require("@aws-sdk/client-rekognition");
const client_s3_1 = require("@aws-sdk/client-s3");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const rekognition = new client_rekognition_1.RekognitionClient({ region: process.env.AWS_REGION });
const s3 = new client_s3_1.S3Client({ region: process.env.AWS_REGION });
const dynamodb = new client_dynamodb_1.DynamoDBClient({ region: process.env.AWS_REGION });
const handler = async (event) => {
    console.log("Rekognition triggered for new image");
    try {
        // Get uploaded file info
        const record = event.Records[0];
        const bucket = record.s3.bucket.name;
        const key = decodeURIComponent(record.s3.object.key.replace(/\+/g, ' '));
        // Only process registration images
        if (!key.startsWith('temp/registration/')) {
            console.log("Skipping non-registration file:", key);
            return;
        }
        // Extract session ID
        const pathParts = key.split('/');
        const sessionId = pathParts[2];
        console.log(`Analyzing image for session: ${sessionId}`);
        // 1. DETECT FACES
        const faceResult = await rekognition.send(new client_rekognition_1.DetectFacesCommand({
            Image: { S3Object: { Bucket: bucket, Name: key } },
            Attributes: ['ALL'],
        }));
        // 2. CHECK FOR INAPPROPRIATE CONTENT
        const moderationResult = await rekognition.send(new client_rekognition_1.DetectModerationLabelsCommand({
            Image: { S3Object: { Bucket: bucket, Name: key } },
            MinConfidence: 75,
        }));
        // Prepare results
        const analysis = {
            sessionId,
            fileKey: key,
            timestamp: new Date().toISOString(),
            faceCount: faceResult.FaceDetails?.length || 0,
            hasFaces: (faceResult.FaceDetails?.length || 0) > 0,
            hasInappropriateContent: (moderationResult.ModerationLabels?.length || 0) > 0,
            isApproved: (faceResult.FaceDetails?.length || 0) > 0 &&
                (moderationResult.ModerationLabels?.length || 0) === 0,
        };
        console.log("Analysis complete:", JSON.stringify(analysis, null, 2));
        // Save to DynamoDB
        await dynamodb.send(new client_dynamodb_1.PutItemCommand({
            TableName: process.env.ANALYSIS_TABLE,
            Item: {
                sessionId: { S: sessionId },
                fileKey: { S: key },
                timestamp: { S: analysis.timestamp },
                faceCount: { N: analysis.faceCount.toString() },
                hasFaces: { BOOL: analysis.hasFaces },
                hasInappropriateContent: { BOOL: analysis.hasInappropriateContent },
                isApproved: { BOOL: analysis.isApproved },
                ttl: { N: Math.floor(Date.now() / 1000 + 86400).toString() },
            },
        }));
        console.log(`Saved analysis for session: ${sessionId}`);
        return { statusCode: 200, body: JSON.stringify(analysis) };
    }
    catch (error) {
        console.error("Rekognition error:", error);
        throw error;
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVrb2duaXRpb24tcHJvY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmVrb2duaXRpb24tcHJvY2Vzc29yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG9FQUFtSDtBQUNuSCxrREFBOEM7QUFDOUMsOERBQTBFO0FBRTFFLE1BQU0sV0FBVyxHQUFHLElBQUksc0NBQWlCLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO0FBQzlFLE1BQU0sRUFBRSxHQUFHLElBQUksb0JBQVEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7QUFDNUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztBQUVqRSxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBVSxFQUFFLEVBQUU7SUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO0lBRW5ELElBQUksQ0FBQztRQUNILHlCQUF5QjtRQUN6QixNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hDLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNyQyxNQUFNLEdBQUcsR0FBRyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRXpFLG1DQUFtQztRQUNuQyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUM7WUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQ0FBaUMsRUFBRSxH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R0FBRyxDQUFDLCtCQUErQixTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBRXhELE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7SUFFN0QsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLG9CQUFvQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzNDLE1BQU0sS0FBSyxDQUFDO0lBQ2QsQ0FBQztBQUNILENBQUMsQ0FBQztBQXRFVyxRQUFBLE9BQU8sV0FzRWxCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVrb2duaXRpb25DbGllbnQsIERldGVjdEZhY2VzQ29tbWFuZCwgRGV0ZWN0TW9kZXJhdGlvbkxhYmVsc0NvbW1hbmQgfSBmcm9tIFwiQGF3cy1zZGsvY2xpZW50LXJla29nbml0aW9uXCI7XHJcbmltcG9ydCB7IFMzQ2xpZW50IH0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1zM1wiO1xyXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCwgUHV0SXRlbUNvbW1hbmQgfSBmcm9tIFwiQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiXCI7XHJcblxyXG5jb25zdCByZWtvZ25pdGlvbiA9IG5ldyBSZWtvZ25pdGlvbkNsaWVudCh7IHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB9KTtcclxuY29uc3QgczMgPSBuZXcgUzNDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfSk7XHJcbmNvbnN0IGR5bmFtb2RiID0gbmV3IER5bmFtb0RCQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIH0pO1xyXG5cclxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IGFueSkgPT4ge1xyXG4gIGNvbnNvbGUubG9nKFwiUmVrb2duaXRpb24gdHJpZ2dlcmVkIGZvciBuZXcgaW1hZ2VcIik7XHJcbiAgXHJcbiAgdHJ5IHtcclxuICAgIC8vIEdldCB1cGxvYWRlZCBmaWxlIGluZm9cclxuICAgIGNvbnN0IHJlY29yZCA9IGV2ZW50LlJlY29yZHNbMF07XHJcbiAgICBjb25zdCBidWNrZXQgPSByZWNvcmQuczMuYnVja2V0Lm5hbWU7XHJcbiAgICBjb25zdCBrZXkgPSBkZWNvZGVVUklDb21wb25lbnQocmVjb3JkLnMzLm9iamVjdC5rZXkucmVwbGFjZSgvXFwrL2csICcgJykpO1xyXG4gICAgXHJcbiAgICAvLyBPbmx5IHByb2Nlc3MgcmVnaXN0cmF0aW9uIGltYWdlc1xyXG4gICAgaWYgKCFrZXkuc3RhcnRzV2l0aCgndGVtcC9yZWdpc3RyYXRpb24vJykpIHtcclxuICAgICAgY29uc29sZS5sb2coXCJTa2lwcGluZyBub24tcmVnaXN0cmF0aW9uIGZpbGU6XCIsIGtleSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gRXh0cmFjdCBzZXNzaW9uIElEXHJcbiAgICBjb25zdCBwYXRoUGFydHMgPSBrZXkuc3BsaXQoJy8nKTtcclxuICAgIGNvbnN0IHNlc3Npb25JZCA9IHBhdGhQYXJ0c1syXTtcclxuICAgIFxyXG4gICAgY29uc29sZS5sb2coYEFuYWx5emluZyBpbWFnZSBmb3Igc2Vzc2lvbjogJHtzZXNzaW9uSWR9YCk7XHJcbiAgICBcclxuICAgIC8vIDEuIERFVEVDVCBGQUNFU1xyXG4gICAgY29uc3QgZmFjZVJlc3VsdCA9IGF3YWl0IHJla29nbml0aW9uLnNlbmQobmV3IERldGVjdEZhY2VzQ29tbWFuZCh7XHJcbiAgICAgIEltYWdlOiB7IFMzT2JqZWN0OiB7IEJ1Y2tldDogYnVja2V0LCBOYW1lOiBrZXkgfSB9LFxyXG4gICAgICBBdHRyaWJ1dGVzOiBbJ0FMTCddLFxyXG4gICAgfSkpO1xyXG4gICAgXHJcbiAgICAvLyAyLiBDSEVDSyBGT1IgSU5BUFBST1BSSUFURSBDT05URU5UXHJcbiAgICBjb25zdCBtb2RlcmF0aW9uUmVzdWx0ID0gYXdhaXQgcmVrb2duaXRpb24uc2VuZChuZXcgRGV0ZWN0TW9kZXJhdGlvbkxhYmVsc0NvbW1hbmQoe1xyXG4gICAgICBJbWFnZTogeyBTM09iamVjdDogeyBCdWNrZXQ6IGJ1Y2tldCwgTmFtZToga2V5IH0gfSxcclxuICAgICAgTWluQ29uZmlkZW5jZTogNzUsXHJcbiAgICB9KSk7XHJcbiAgICBcclxuICAgIC8vIFByZXBhcmUgcmVzdWx0c1xyXG4gICAgY29uc3QgYW5hbHlzaXMgPSB7XHJcbiAgICAgIHNlc3Npb25JZCxcclxuICAgICAgZmlsZUtleToga2V5LFxyXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgZmFjZUNvdW50OiBmYWNlUmVzdWx0LkZhY2VEZXRhaWxzPy5sZW5ndGggfHwgMCxcclxuICAgICAgaGFzRmFjZXM6IChmYWNlUmVzdWx0LkZhY2VEZXRhaWxzPy5sZW5ndGggfHwgMCkgPiAwLFxyXG4gICAgICBoYXNJbmFwcHJvcHJpYXRlQ29udGVudDogKG1vZGVyYXRpb25SZXN1bHQuTW9kZXJhdGlvbkxhYmVscz8ubGVuZ3RoIHx8IDApID4gMCxcclxuICAgICAgaXNBcHByb3ZlZDogKGZhY2VSZXN1bHQuRmFjZURldGFpbHM/Lmxlbmd0aCB8fCAwKSA+IDAgJiYgXHJcbiAgICAgICAgICAgICAgICAgIChtb2RlcmF0aW9uUmVzdWx0Lk1vZGVyYXRpb25MYWJlbHM/Lmxlbmd0aCB8fCAwKSA9PT0gMCxcclxuICAgIH07XHJcbiAgICBcclxuICAgIGNvbnNvbGUubG9nKFwiQW5hbHlzaXMgY29tcGxldGU6XCIsIEpTT04uc3RyaW5naWZ5KGFuYWx5c2lzLCBudWxsLCAyKSk7XHJcbiAgICBcclxuICAgIC8vIFNhdmUgdG8gRHluYW1vREJcclxuICAgIGF3YWl0IGR5bmFtb2RiLnNlbmQobmV3IFB1dEl0ZW1Db21tYW5kKHtcclxuICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5BTkFMWVNJU19UQUJMRSEsXHJcbiAgICAgIEl0ZW06IHtcclxuICAgICAgICBzZXNzaW9uSWQ6IHsgUzogc2Vzc2lvbklkIH0sXHJcbiAgICAgICAgZmlsZUtleTogeyBTOiBrZXkgfSxcclxuICAgICAgICB0aW1lc3RhbXA6IHsgUzogYW5hbHlzaXMudGltZXN0YW1wIH0sXHJcbiAgICAgICAgZmFjZUNvdW50OiB7IE46IGFuYWx5c2lzLmZhY2VDb3VudC50b1N0cmluZygpIH0sXHJcbiAgICAgICAgaGFzRmFjZXM6IHsgQk9PTDogYW5hbHlzaXMuaGFzRmFjZXMgfSxcclxuICAgICAgICBoYXNJbmFwcHJvcHJpYXRlQ29udGVudDogeyBCT09MOiBhbmFseXNpcy5oYXNJbmFwcHJvcHJpYXRlQ29udGVudCB9LFxyXG4gICAgICAgIGlzQXBwcm92ZWQ6IHsgQk9PTDogYW5hbHlzaXMuaXNBcHByb3ZlZCB9LFxyXG4gICAgICAgIHR0bDogeyBOOiBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwICsgODY0MDApLnRvU3RyaW5nKCkgfSxcclxuICAgICAgfSxcclxuICAgIH0pKTtcclxuICAgIFxyXG4gICAgY29uc29sZS5sb2coYFNhdmVkIGFuYWx5c2lzIGZvciBzZXNzaW9uOiAke3Nlc3Npb25JZH1gKTtcclxuICAgIFxyXG4gICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogMjAwLCBib2R5OiBKU09OLnN0cmluZ2lmeShhbmFseXNpcykgfTtcclxuICAgIFxyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKFwiUmVrb2duaXRpb24gZXJyb3I6XCIsIGVycm9yKTtcclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxufTsiXX0=