"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const ddb = new client_dynamodb_1.DynamoDBClient({});
const TABLE_NAME = process.env.PLUG_ACTIONS_TABLE;
const VOICE_MONKEY_BASE_URL = process.env.VOICE_MONKEY_BASE_URL;
const VOICE_MONKEY_TOKEN = process.env.VOICE_MONKEY_TOKEN;
const COOLDOWN_SECONDS = parseInt(process.env.COOLDOWN_SECONDS || "30", 10);
const PLUG_DEVICE_MAP = JSON.parse(process.env.PLUG_DEVICE_MAP || "{}");
const handler = async (event) => {
    try {
        // ────────────────────────────────
        // 1) Extract user from Cognito
        // ────────────────────────────────
        const claims = event.requestContext.authorizer?.claims;
        const userId = claims?.sub;
        if (!userId) {
            return {
                statusCode: 401,
                body: JSON.stringify({ message: "Unauthorized: no user id" }),
            };
        }
        // ────────────────────────────────
        // 2) Parse body: { plugId, state }
        // ────────────────────────────────
        if (!event.body) {
            return {
                statusCode: 400,
                body: JSON.stringify({ message: "Missing body" }),
            };
        }
        let parsed;
        try {
            parsed = JSON.parse(event.body);
        }
        catch {
            return {
                statusCode: 400,
                body: JSON.stringify({ message: "Invalid JSON" }),
            };
        }
        const plugId = (parsed.plugId || "").toString();
        const state = (parsed.state || "").toString().toLowerCase(); // "on" | "off"
        if (!plugId || !["on", "off"].includes(state)) {
            return {
                statusCode: 400,
                body: JSON.stringify({
                    message: "Invalid payload. Expected { plugId: 'plug1'|'plug2', state: 'on'|'off' }",
                }),
            };
        }
        if (!PLUG_DEVICE_MAP[plugId]) {
            return {
                statusCode: 400,
                body: JSON.stringify({ message: `Unknown plugId: ${plugId}` }),
            };
        }
        const deviceId = state === "on"
            ? PLUG_DEVICE_MAP[plugId].on
            : PLUG_DEVICE_MAP[plugId].off;
        // ────────────────────────────────
        // 3) Cooldown: check last action for this user
        // ────────────────────────────────
        const nowSeconds = Math.floor(Date.now() / 1000);
        const query = new client_dynamodb_1.QueryCommand({
            TableName: TABLE_NAME,
            KeyConditionExpression: "user_id = :u",
            ExpressionAttributeValues: {
                ":u": { S: userId },
            },
            Limit: 1,
            ScanIndexForward: false, // latest first
        });
        const queryRes = await ddb.send(query);
        const lastItem = queryRes.Items?.[0];
        if (lastItem?.ts?.N) {
            const lastTs = parseInt(lastItem.ts.N, 10);
            const diff = nowSeconds - lastTs;
            if (diff < COOLDOWN_SECONDS) {
                const retryAfter = COOLDOWN_SECONDS - diff;
                return {
                    statusCode: 429,
                    headers: {
                        "Retry-After": retryAfter.toString(),
                    },
                    body: JSON.stringify({
                        message: `Cooldown active. Please wait ${retryAfter} seconds.`,
                        retryAfter,
                    }),
                };
            }
        }
        // ────────────────────────────────
        // 4) Call Voice Monkey
        // ────────────────────────────────
        const url = new URL(VOICE_MONKEY_BASE_URL);
        url.searchParams.set("token", VOICE_MONKEY_TOKEN);
        url.searchParams.set("device", deviceId);
        const vmRes = await fetch(url.toString(), {
            method: "GET",
        });
        const vmText = await vmRes.text();
        if (!vmRes.ok) {
            console.error("Voice Monkey error:", vmRes.status, vmText);
            return {
                statusCode: 502,
                body: JSON.stringify({
                    message: "Failed to trigger Voice Monkey",
                    status: vmRes.status,
                    response: vmText,
                }),
            };
        }
        // ────────────────────────────────
        // 5) Log to DynamoDB
        // ────────────────────────────────
        const put = new client_dynamodb_1.PutItemCommand({
            TableName: TABLE_NAME,
            Item: {
                user_id: { S: userId },
                ts: { N: nowSeconds.toString() },
                plug_id: { S: plugId },
                action: { S: state },
                vm_device: { S: deviceId },
                vm_response: { S: vmText.slice(0, 500) }, // keep it short
            },
        });
        await ddb.send(put);
        return {
            statusCode: 200,
            body: JSON.stringify({
                ok: true,
                plugId,
                state,
                vmResponse: vmText,
                nextAllowedAt: nowSeconds + COOLDOWN_SECONDS,
            }),
        };
    }
    catch (err) {
        console.error("Unexpected error:", err);
        return {
            statusCode: 500,
            body: JSON.stringify({ message: "Internal server error" }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Zy1jb250cm9sLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGx1Zy1jb250cm9sLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDhEQUlrQztBQUVsQyxNQUFNLEdBQUcsR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFbkMsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBbUIsQ0FBQztBQUNuRCxNQUFNLHFCQUFxQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXNCLENBQUM7QUFDakUsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFtQixDQUFDO0FBQzNELE1BQU0sZ0JBQWdCLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLElBQUksSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBTTVFLE1BQU0sZUFBZSxHQUFrQixJQUFJLENBQUMsS0FBSyxDQUMvQyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQ3BDLENBQUM7QUFFSyxNQUFNLE9BQU8sR0FBMkIsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFO0lBQzdELElBQUksQ0FBQztRQUNILG1DQUFtQztRQUNuQywrQkFBK0I7UUFDL0IsbUNBQW1DO1FBQ25DLE1BQU0sTUFBTSxHQUFJLEtBQUssQ0FBQyxjQUFjLENBQUMsVUFBa0IsRUFBRSxNQUFNLENBQUM7UUFDaEUsTUFBTSxNQUFNLEdBQUcsTUFBTSxFQUFFLEdBQXlCLENBQUM7UUFFakQsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ1osT0FBTztnQkFDTCxVQUFVLEVBQUUsR0FBRztnQkFDZixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxDQUFDO2FBQzlELENBQUM7UUFDSixDQUFDO1FBRUQsbUNBQW1DO1FBQ25DLG1DQUFtQztRQUNu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InNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUhhbmRsZXIgfSBmcm9tIFwiYXdzLWxhbWJkYVwiO1xyXG5pbXBvcnQge1xyXG4gIER5bmFtb0RCQ2xpZW50LFxyXG4gIFF1ZXJ5Q29tbWFuZCxcclxuICBQdXRJdGVtQ29tbWFuZCxcclxufSBmcm9tIFwiQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiXCI7XHJcblxyXG5jb25zdCBkZGIgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xyXG5cclxuY29uc3QgVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LlBMVUdfQUNUSU9OU19UQUJMRSE7XHJcbmNvbnN0IFZPSUNFX01PTktFWV9CQVNFX1VSTCA9IHByb2Nlc3MuZW52LlZPSUNFX01PTktFWV9CQVNFX1VSTCE7XHJcbmNvbnN0IFZPSUNFX01PTktFWV9UT0tFTiA9IHByb2Nlc3MuZW52LlZPSUNFX01PTktFWV9UT0tFTiE7XHJcbmNvbnN0IENPT0xET1dOX1NFQ09ORFMgPSBwYXJzZUludChwcm9jZXNzLmVudi5DT09MRE9XTl9TRUNPTkRTIHx8IFwiMzBcIiwgMTApO1xyXG5cclxudHlwZSBQbHVnRGV2aWNlTWFwID0ge1xyXG4gIFtwbHVnSWQ6IHN0cmluZ106IHsgb246IHN0cmluZzsgb2ZmOiBzdHJpbmcgfTtcclxufTtcclxuXHJcbmNvbnN0IFBMVUdfREVWSUNFX01BUDogUGx1Z0RldmljZU1hcCA9IEpTT04ucGFyc2UoXHJcbiAgcHJvY2Vzcy5lbnYuUExVR19ERVZJQ0VfTUFQIHx8IFwie31cIlxyXG4pO1xyXG5cclxuZXhwb3J0IGNvbnN0IGhhbmRsZXI6IEFQSUdhdGV3YXlQcm94eUhhbmRsZXIgPSBhc3luYyAoZXZlbnQpID0+IHtcclxuICB0cnkge1xyXG4gICAgLy8g4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAXHJcbiAgICAvLyAxKSBFeHRyYWN0IHVzZXIgZnJvbSBDb2duaXRvXHJcbiAgICAvLyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIBcclxuICAgIGNvbnN0IGNsYWltcyA9IChldmVudC5yZXF1ZXN0Q29udGV4dC5hdXRob3JpemVyIGFzIGFueSk/LmNsYWltcztcclxuICAgIGNvbnN0IHVzZXJJZCA9IGNsYWltcz8uc3ViIGFzIHN0cmluZyB8IHVuZGVmaW5lZDtcclxuXHJcbiAgICBpZiAoIXVzZXJJZCkge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMSxcclxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6IFwiVW5hdXRob3JpemVkOiBubyB1c2VyIGlkXCIgfSksXHJcbiAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgLy8g4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAXHJcbiAgICAvLyAyKSBQYXJzZSBib2R5OiB7IHBsdWdJZCwgc3RhdGUgfVxyXG4gICAgLy8g4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAXHJcbiAgICBpZiAoIWV2ZW50LmJvZHkpIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXHJcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBcIk1pc3NpbmcgYm9keVwiIH0pLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBwYXJzZWQ6IGFueTtcclxuICAgIHRyeSB7XHJcbiAgICAgIHBhcnNlZCA9IEpTT04ucGFyc2UoZXZlbnQuYm9keSk7XHJcbiAgICB9IGNhdGNoIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXHJcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBcIkludmFsaWQgSlNPTlwiIH0pLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHBsdWdJZCA9IChwYXJzZWQucGx1Z0lkIHx8IFwiXCIpLnRvU3RyaW5nKCk7XHJcbiAgICBjb25zdCBzdGF0ZSA9IChwYXJzZWQuc3RhdGUgfHwgXCJcIikudG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpOyAvLyBcIm9uXCIgfCBcIm9mZlwiXHJcblxyXG4gICAgaWYgKCFwbHVnSWQgfHwgIVtcIm9uXCIsIFwib2ZmXCJdLmluY2x1ZGVzKHN0YXRlKSkge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcclxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICBtZXNzYWdlOlxyXG4gICAgICAgICAgICBcIkludmFsaWQgcGF5bG9hZC4gRXhwZWN0ZWQgeyBwbHVnSWQ6ICdwbHVnMSd8J3BsdWcyJywgc3RhdGU6ICdvbid8J29mZicgfVwiLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghUExVR19ERVZJQ0VfTUFQW3BsdWdJZF0pIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXHJcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBgVW5rbm93biBwbHVnSWQ6ICR7cGx1Z0lkfWAgfSksXHJcbiAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZGV2aWNlSWQgPVxyXG4gICAgICBzdGF0ZSA9PT0gXCJvblwiXHJcbiAgICAgICAgPyBQTFVHX0RFVklDRV9NQVBbcGx1Z0lkXS5vblxyXG4gICAgICAgIDogUExVR19ERVZJQ0VfTUFQW3BsdWdJZF0ub2ZmO1xyXG5cclxuICAgIC8vIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgFxyXG4gICAgLy8gMykgQ29vbGRvd246IGNoZWNrIGxhc3QgYWN0aW9uIGZvciB0aGlzIHVzZXJcclxuICAgIC8vIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgFxyXG4gICAgY29uc3Qgbm93U2Vjb25kcyA9IE1hdGguZmxvb3IoRGF0ZS5ub3coKSAvIDEwMDApO1xyXG5cclxuICAgIGNvbnN0IHF1ZXJ5ID0gbmV3IFF1ZXJ5Q29tbWFuZCh7XHJcbiAgICAgIFRhYmxlTmFtZTogVEFCTEVfTkFNRSxcclxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogXCJ1c2VyX2lkID0gOnVcIixcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xyXG4gICAgICAgIFwiOnVcIjogeyBTOiB1c2VySWQgfSxcclxuICAgICAgfSxcclxuICAgICAgTGltaXQ6IDEsXHJcbiAgICAgIFNjYW5JbmRleEZvcndhcmQ6IGZhbHNlLCAvLyBsYXRlc3QgZmlyc3RcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IHF1ZXJ5UmVzID0gYXdhaXQgZGRiLnNlbmQocXVlcnkpO1xyXG4gICAgY29uc3QgbGFzdEl0ZW0gPSBxdWVyeVJlcy5JdGVtcz8uWzBdO1xyXG5cclxuICAgIGlmIChsYXN0SXRlbT8udHM/Lk4pIHtcclxuICAgICAgY29uc3QgbGFzdFRzID0gcGFyc2VJbnQobGFzdEl0ZW0udHMuTiwgMTApO1xyXG4gICAgICBjb25zdCBkaWZmID0gbm93U2Vjb25kcyAtIGxhc3RUcztcclxuXHJcbiAgICAgIGlmIChkaWZmIDwgQ09PTERPV05fU0VDT05EUykge1xyXG4gICAgICAgIGNvbnN0IHJldHJ5QWZ0ZXIgPSBDT09MRE9XTl9TRUNPTkRTIC0gZGlmZjtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgc3RhdHVzQ29kZTogNDI5LFxyXG4gICAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgICBcIlJldHJ5LUFmdGVyXCI6IHJldHJ5QWZ0ZXIudG9TdHJpbmcoKSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IGBDb29sZG93biBhY3RpdmUuIFBsZWFzZSB3YWl0ICR7cmV0cnlBZnRlcn0gc2Vjb25kcy5gLFxyXG4gICAgICAgICAgICByZXRyeUFmdGVyLFxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgfTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgFxyXG4gICAgLy8gNCkgQ2FsbCBWb2ljZSBNb25rZXlcclxuICAgIC8vIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgFxyXG4gICAgY29uc3QgdXJsID0gbmV3IFVSTChWT0lDRV9NT05LRVlfQkFTRV9VUkwpO1xyXG4gICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoXCJ0b2tlblwiLCBWT0lDRV9NT05LRVlfVE9LRU4pO1xyXG4gICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoXCJkZXZpY2VcIiwgZGV2aWNlSWQpO1xyXG5cclxuICAgIGNvbnN0IHZtUmVzID0gYXdhaXQgZmV0Y2godXJsLnRvU3RyaW5nKCksIHtcclxuICAgICAgbWV0aG9kOiBcIkdFVFwiLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3Qgdm1UZXh0ID0gYXdhaXQgdm1SZXMudGV4dCgpO1xyXG4gICAgaWYgKCF2bVJlcy5vaykge1xyXG4gICAgICBjb25zb2xlLmVycm9yKFwiVm9pY2UgTW9ua2V5IGVycm9yOlwiLCB2bVJlcy5zdGF0dXMsIHZtVGV4dCk7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgc3RhdHVzQ29kZTogNTAyLFxyXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICAgIG1lc3NhZ2U6IFwiRmFpbGVkIHRvIHRyaWdnZXIgVm9pY2UgTW9ua2V5XCIsXHJcbiAgICAgICAgICBzdGF0dXM6IHZtUmVzLnN0YXR1cyxcclxuICAgICAgICAgIHJlc3BvbnNlOiB2bVRleHQsXHJcbiAgICAgICAgfSksXHJcbiAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgLy8g4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAXHJcbiAgICAvLyA1KSBMb2cgdG8gRHluYW1vREJcclxuICAgIC8vIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgFxyXG4gICAgY29uc3QgcHV0ID0gbmV3IFB1dEl0ZW1Db21tYW5kKHtcclxuICAgICAgVGFibGVOYW1lOiBUQUJMRV9OQU1FLFxyXG4gICAgICBJdGVtOiB7XHJcbiAgICAgICAgdXNlcl9pZDogeyBTOiB1c2VySWQgfSxcclxuICAgICAgICB0czogeyBOOiBub3dTZWNvbmRzLnRvU3RyaW5nKCkgfSxcclxuICAgICAgICBwbHVnX2lkOiB7IFM6IHBsdWdJZCB9LFxyXG4gICAgICAgIGFjdGlvbjogeyBTOiBzdGF0ZSB9LFxyXG4gICAgICAgIHZtX2RldmljZTogeyBTOiBkZXZpY2VJZCB9LFxyXG4gICAgICAgIHZtX3Jlc3BvbnNlOiB7IFM6IHZtVGV4dC5zbGljZSgwLCA1MDApIH0sIC8vIGtlZXAgaXQgc2hvcnRcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG5cclxuICAgIGF3YWl0IGRkYi5zZW5kKHB1dCk7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3RhdHVzQ29kZTogMjAwLFxyXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgb2s6IHRydWUsXHJcbiAgICAgICAgcGx1Z0lkLFxyXG4gICAgICAgIHN0YXRlLFxyXG4gICAgICAgIHZtUmVzcG9uc2U6IHZtVGV4dCxcclxuICAgICAgICBuZXh0QWxsb3dlZEF0OiBub3dTZWNvbmRzICsgQ09PTERPV05fU0VDT05EUyxcclxuICAgICAgfSksXHJcbiAgICB9O1xyXG4gIH0gY2F0Y2ggKGVycjogYW55KSB7XHJcbiAgICBjb25zb2xlLmVycm9yKFwiVW5leHBlY3RlZCBlcnJvcjpcIiwgZXJyKTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcclxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBcIkludGVybmFsIHNlcnZlciBlcnJvclwiIH0pLFxyXG4gICAgfTtcclxuICB9XHJcbn07XHJcbiJdfQ==