"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const http_response_1 = require("./http-response");
const ws_broadcast_1 = require("./ws-broadcast");
const ddb = new client_dynamodb_1.DynamoDBClient({});
const TABLE_NAME = process.env.PLUG_ACTIONS_TABLE;
const VOICE_MONKEY_BASE_URL = process.env.VOICE_MONKEY_BASE_URL;
const VOICE_MONKEY_TOKEN = process.env.VOICE_MONKEY_TOKEN;
const COOLDOWN_SECONDS = parseInt(process.env.COOLDOWN_SECONDS || "30", 10);
const PLUG_DEVICE_MAP = JSON.parse(process.env.PLUG_DEVICE_MAP || "{}");
const handler = async (event) => {
    try {
        // ────────────────────────────────
        // 1) Extract user from Cognito
        // ────────────────────────────────
        const claims = event.requestContext.authorizer?.claims;
        const userId = claims?.sub;
        if (!userId) {
            return (0, http_response_1.jsonResponse)(401, { message: "Unauthorized: no user id" });
        }
        // ────────────────────────────────
        // 2) Parse body: { plugId, state }
        // ────────────────────────────────
        if (!event.body) {
            return (0, http_response_1.jsonResponse)(400, { message: "Missing body" });
        }
        let parsed;
        try {
            parsed = JSON.parse(event.body);
        }
        catch {
            return (0, http_response_1.jsonResponse)(400, { message: "Invalid JSON" });
        }
        const plugId = (parsed.plugId || "").toString();
        const state = (parsed.state || "").toString().toLowerCase(); // "on" | "off"
        if (!plugId || !["on", "off"].includes(state)) {
            return (0, http_response_1.jsonResponse)(400, {
                message: "Invalid payload. Expected { plugId: 'plug1'|'plug2', state: 'on'|'off' }",
            });
        }
        if (!PLUG_DEVICE_MAP[plugId]) {
            return (0, http_response_1.jsonResponse)(400, { message: `Unknown plugId: ${plugId}` });
        }
        const deviceId = state === "on"
            ? PLUG_DEVICE_MAP[plugId].on
            : PLUG_DEVICE_MAP[plugId].off;
        // ────────────────────────────────
        // 3) Cooldown: check last action for this user
        // ────────────────────────────────
        const nowSeconds = Math.floor(Date.now() / 1000);
        const query = new client_dynamodb_1.QueryCommand({
            TableName: TABLE_NAME,
            KeyConditionExpression: "user_id = :u",
            ExpressionAttributeValues: {
                ":u": { S: userId },
            },
            Limit: 1,
            ScanIndexForward: false, // latest first
        });
        const queryRes = await ddb.send(query);
        const lastItem = queryRes.Items?.[0];
        if (lastItem?.ts?.N) {
            const lastTs = parseInt(lastItem.ts.N, 10);
            const diff = nowSeconds - lastTs;
            if (diff < COOLDOWN_SECONDS) {
                const retryAfter = COOLDOWN_SECONDS - diff;
                // Broadcast cooldown info, but don't break the HTTP flow if it fails
                try {
                    await (0, ws_broadcast_1.broadcastToAll)({
                        type: "plug_action",
                        source: "plug-control",
                        ts: nowSeconds,
                        payload: {
                            plugId,
                            state, // requested state
                            userId,
                            cooldown: {
                                active: true,
                                retryAfter,
                                nextAllowedAt: nowSeconds + retryAfter,
                            },
                            status: 429,
                            message: `Cooldown active. Please wait ${retryAfter} seconds.`,
                        },
                    });
                }
                catch (e) {
                    console.error("WS broadcast (cooldown) failed:", e);
                }
                return (0, http_response_1.jsonResponse)(429, {
                    message: `Cooldown active. Please wait ${retryAfter} seconds.`,
                    retryAfter,
                }, { "Retry-After": retryAfter.toString() });
            }
        }
        // ────────────────────────────────
        // 4) Call Voice Monkey
        // ────────────────────────────────
        const url = new URL(VOICE_MONKEY_BASE_URL);
        url.searchParams.set("token", VOICE_MONKEY_TOKEN);
        url.searchParams.set("device", deviceId);
        const vmRes = await fetch(url.toString(), {
            method: "GET",
        });
        const vmText = await vmRes.text();
        if (!vmRes.ok) {
            console.error("Voice Monkey error:", vmRes.status, vmText);
            return (0, http_response_1.jsonResponse)(502, {
                message: "Failed to trigger Voice Monkey",
                status: vmRes.status,
                response: vmText,
            });
        }
        // ────────────────────────────────
        // 5) Log to DynamoDB
        // ────────────────────────────────
        const put = new client_dynamodb_1.PutItemCommand({
            TableName: TABLE_NAME,
            Item: {
                user_id: { S: userId },
                ts: { N: nowSeconds.toString() },
                plug_id: { S: plugId },
                action: { S: state },
                vm_device: { S: deviceId },
                vm_response: { S: vmText.slice(0, 500) }, // truncate if too long
            },
        });
        await ddb.send(put);
        const responseBody = {
            ok: true,
            plugId,
            state,
            vmResponse: vmText,
            nextAllowedAt: nowSeconds + COOLDOWN_SECONDS,
        };
        // ────────────────────────────────
        // 6) Broadcast successful action over WebSocket
        // ────────────────────────────────
        try {
            await (0, ws_broadcast_1.broadcastToAll)({
                type: "plug_action",
                source: "plug-control",
                ts: nowSeconds,
                payload: {
                    plugId,
                    state,
                    userId,
                    cooldown: {
                        active: false,
                        nextAllowedAt: nowSeconds + COOLDOWN_SECONDS,
                    },
                    status: 200,
                    message: "Plug action accepted",
                },
            });
        }
        catch (e) {
            console.error("WS broadcast (success) failed:", e);
            // don't change HTTP result
        }
        return (0, http_response_1.jsonResponse)(200, responseBody);
    }
    catch (err) {
        console.error("Unexpected error:", err);
        return (0, http_response_1.jsonResponse)(500, { message: "Internal server error" });
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Zy1jb250cm9sLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGx1Zy1jb250cm9sLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDhEQUlrQztBQUNsQyxtREFBK0M7QUFDL0MsaURBQWdEO0FBRWhELE1BQU0sR0FBRyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVuQyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFtQixDQUFDO0FBQ25ELE1BQU0scUJBQXFCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBc0IsQ0FBQztBQUNqRSxNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQW1CLENBQUM7QUFDM0QsTUFBTSxnQkFBZ0IsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsSUFBSSxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFNNUUsTUFBTSxlQUFlLEdBQWtCLElBQUksQ0FBQyxLQUFLLENBQy9DLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxJQUFJLElBQUksQ0FDcEMsQ0FBQztBQUVLLE1BQU0sT0FBTyxHQUEyQixLQUFLLEVBQUUsS0FBSyxFQUFFLEVBQUU7SUFDN0QsSUFBSSxDQUFDO1FBQ0gsbUNBQW1DO1FBQ25DLCtCQUErQjtRQUMvQixtQ0FBbUM7UUFDbkMsTUFBTSxNQUFNLEdBQUksS0FBSyxDQUFDLGNBQWMsQ0FBQyxVQUFrQixFQUFFLE1BQU0sQ0FBQztRQUNoRSxNQUFNLE1BQU0sR0FBRyxNQUFNLEVBQUUsR0FBeUIsQ0FBQztRQUVqRCxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDWixPQUFPLElBQUEsNEJBQVksRUFBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsQ0FBQyxDQUFDO1FBQ3BFLENBQUM7UUFFRCxtQ0FBbUM7UUFDbkMsbUNBQW1DO1FBQ25DLG1DQUFtQztR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QUFhO2dCQUNuQixNQUFNLEVBQUUsY0FBYztnQkFDdEIsRUFBRSxFQUFFLFVBQVU7Z0JBQ2QsT0FBTyxFQUFFO29CQUNQLE1BQU07b0JBQ04sS0FBSztvQkFDTCxNQUFNO29CQUNOLFFBQVEsRUFBRTt3QkFDUixNQUFNLEVBQUUsS0FBSzt3QkFDYixhQUFhLEVBQUUsVUFBVSxHQUFHLGdCQUFnQjtxQkFDN0M7b0JBQ0QsTUFBTSxFQUFFLEdBQUc7b0JBQ1gsT0FBTyxFQUFFLHNCQUFzQjtpQkFDaEM7YUFDRixDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNYLE9BQU8sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDbkQsMkJBQTJCO1FBQzdCLENBQUM7UUFFRCxPQUFPLElBQUEsNEJBQVksRUFBQyxHQUFHLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUFDLE9BQU8sR0FBUSxFQUFFLENBQUM7UUFDbEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUN4QyxPQUFPLElBQUEsNEJBQVksRUFBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDO0lBQ2pFLENBQUM7QUFDSCxDQUFDLENBQUM7QUFwTFcsUUFBQSxPQUFPLFdBb0xsQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUhhbmRsZXIgfSBmcm9tIFwiYXdzLWxhbWJkYVwiO1xyXG5pbXBvcnQge1xyXG4gIER5bmFtb0RCQ2xpZW50LFxyXG4gIFF1ZXJ5Q29tbWFuZCxcclxuICBQdXRJdGVtQ29tbWFuZCxcclxufSBmcm9tIFwiQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiXCI7XHJcbmltcG9ydCB7IGpzb25SZXNwb25zZSB9IGZyb20gXCIuL2h0dHAtcmVzcG9uc2VcIjtcclxuaW1wb3J0IHsgYnJvYWRjYXN0VG9BbGwgfSBmcm9tIFwiLi93cy1icm9hZGNhc3RcIjtcclxuXHJcbmNvbnN0IGRkYiA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XHJcblxyXG5jb25zdCBUQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuUExVR19BQ1RJT05TX1RBQkxFITtcclxuY29uc3QgVk9JQ0VfTU9OS0VZX0JBU0VfVVJMID0gcHJvY2Vzcy5lbnYuVk9JQ0VfTU9OS0VZX0JBU0VfVVJMITtcclxuY29uc3QgVk9JQ0VfTU9OS0VZX1RPS0VOID0gcHJvY2Vzcy5lbnYuVk9JQ0VfTU9OS0VZX1RPS0VOITtcclxuY29uc3QgQ09PTERPV05fU0VDT05EUyA9IHBhcnNlSW50KHByb2Nlc3MuZW52LkNPT0xET1dOX1NFQ09ORFMgfHwgXCIzMFwiLCAxMCk7XHJcblxyXG50eXBlIFBsdWdEZXZpY2VNYXAgPSB7XHJcbiAgW3BsdWdJZDogc3RyaW5nXTogeyBvbjogc3RyaW5nOyBvZmY6IHN0cmluZyB9O1xyXG59O1xyXG5cclxuY29uc3QgUExVR19ERVZJQ0VfTUFQOiBQbHVnRGV2aWNlTWFwID0gSlNPTi5wYXJzZShcclxuICBwcm9jZXNzLmVudi5QTFVHX0RFVklDRV9NQVAgfHwgXCJ7fVwiXHJcbik7XHJcblxyXG5leHBvcnQgY29uc3QgaGFuZGxlcjogQVBJR2F0ZXdheVByb3h5SGFuZGxlciA9IGFzeW5jIChldmVudCkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICAvLyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIBcclxuICAgIC8vIDEpIEV4dHJhY3QgdXNlciBmcm9tIENvZ25pdG9cclxuICAgIC8vIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgFxyXG4gICAgY29uc3QgY2xhaW1zID0gKGV2ZW50LnJlcXVlc3RDb250ZXh0LmF1dGhvcml6ZXIgYXMgYW55KT8uY2xhaW1zO1xyXG4gICAgY29uc3QgdXNlcklkID0gY2xhaW1zPy5zdWIgYXMgc3RyaW5nIHwgdW5kZWZpbmVkO1xyXG5cclxuICAgIGlmICghdXNlcklkKSB7XHJcbiAgICAgIHJldHVybiBqc29uUmVzcG9uc2UoNDAxLCB7IG1lc3NhZ2U6IFwiVW5hdXRob3JpemVkOiBubyB1c2VyIGlkXCIgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAXHJcbiAgICAvLyAyKSBQYXJzZSBib2R5OiB7IHBsdWdJZCwgc3RhdGUgfVxyXG4gICAgLy8g4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAXHJcbiAgICBpZiAoIWV2ZW50LmJvZHkpIHtcclxuICAgICAgcmV0dXJuIGpzb25SZXNwb25zZSg0MDAsIHsgbWVzc2FnZTogXCJNaXNzaW5nIGJvZHlcIiB9KTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcGFyc2VkOiBhbnk7XHJcbiAgICB0cnkge1xyXG4gICAgICBwYXJzZWQgPSBKU09OLnBhcnNlKGV2ZW50LmJvZHkpO1xyXG4gICAgfSBjYXRjaCB7XHJcbiAgICAgIHJldHVybiBqc29uUmVzcG9uc2UoNDAwLCB7IG1lc3NhZ2U6IFwiSW52YWxpZCBKU09OXCIgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcGx1Z0lkID0gKHBhcnNlZC5wbHVnSWQgfHwgXCJcIikudG9TdHJpbmcoKTtcclxuICAgIGNvbnN0IHN0YXRlID0gKHBhcnNlZC5zdGF0ZSB8fCBcIlwiKS50b1N0cmluZygpLnRvTG93ZXJDYXNlKCk7IC8vIFwib25cIiB8IFwib2ZmXCJcclxuXHJcbiAgICBpZiAoIXBsdWdJZCB8fCAhW1wib25cIiwgXCJvZmZcIl0uaW5jbHVkZXMoc3RhdGUpKSB7XHJcbiAgICAgIHJldHVybiBqc29uUmVzcG9uc2UoNDAwLCB7XHJcbiAgICAgICAgbWVzc2FnZTpcclxuICAgICAgICAgIFwiSW52YWxpZCBwYXlsb2FkLiBFeHBlY3RlZCB7IHBsdWdJZDogJ3BsdWcxJ3wncGx1ZzInLCBzdGF0ZTogJ29uJ3wnb2ZmJyB9XCIsXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghUExVR19ERVZJQ0VfTUFQW3BsdWdJZF0pIHtcclxuICAgICAgcmV0dXJuIGpzb25SZXNwb25zZSg0MDAsIHsgbWVzc2FnZTogYFVua25vd24gcGx1Z0lkOiAke3BsdWdJZH1gIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGRldmljZUlkID1cclxuICAgICAgc3RhdGUgPT09IFwib25cIlxyXG4gICAgICAgID8gUExVR19ERVZJQ0VfTUFQW3BsdWdJZF0ub25cclxuICAgICAgICA6IFBMVUdfREVWSUNFX01BUFtwbHVnSWRdLm9mZjtcclxuXHJcbiAgICAvLyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIBcclxuICAgIC8vIDMpIENvb2xkb3duOiBjaGVjayBsYXN0IGFjdGlvbiBmb3IgdGhpcyB1c2VyXHJcbiAgICAvLyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIBcclxuICAgIGNvbnN0IG5vd1NlY29uZHMgPSBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKTtcclxuXHJcbiAgICBjb25zdCBxdWVyeSA9IG5ldyBRdWVyeUNvbW1hbmQoe1xyXG4gICAgICBUYWJsZU5hbWU6IFRBQkxFX05BTUUsXHJcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246IFwidXNlcl9pZCA9IDp1XCIsXHJcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcclxuICAgICAgICBcIjp1XCI6IHsgUzogdXNlcklkIH0sXHJcbiAgICAgIH0sXHJcbiAgICAgIExpbWl0OiAxLFxyXG4gICAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZSwgLy8gbGF0ZXN0IGZpcnN0XHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCBxdWVyeVJlcyA9IGF3YWl0IGRkYi5zZW5kKHF1ZXJ5KTtcclxuICAgIGNvbnN0IGxhc3RJdGVtID0gcXVlcnlSZXMuSXRlbXM/LlswXTtcclxuXHJcbiAgICBpZiAobGFzdEl0ZW0/LnRzPy5OKSB7XHJcbiAgICAgIGNvbnN0IGxhc3RUcyA9IHBhcnNlSW50KGxhc3RJdGVtLnRzLk4sIDEwKTtcclxuICAgICAgY29uc3QgZGlmZiA9IG5vd1NlY29uZHMgLSBsYXN0VHM7XHJcblxyXG4gICAgICBpZiAoZGlmZiA8IENPT0xET1dOX1NFQ09ORFMpIHtcclxuICAgICAgICBjb25zdCByZXRyeUFmdGVyID0gQ09PTERPV05fU0VDT05EUyAtIGRpZmY7XHJcblxyXG4gICAgICAgIC8vIEJyb2FkY2FzdCBjb29sZG93biBpbmZvLCBidXQgZG9uJ3QgYnJlYWsgdGhlIEhUVFAgZmxvdyBpZiBpdCBmYWlsc1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICBhd2FpdCBicm9hZGNhc3RUb0FsbCh7XHJcbiAgICAgICAgICAgIHR5cGU6IFwicGx1Z19hY3Rpb25cIixcclxuICAgICAgICAgICAgc291cmNlOiBcInBsdWctY29udHJvbFwiLFxyXG4gICAgICAgICAgICB0czogbm93U2Vjb25kcyxcclxuICAgICAgICAgICAgcGF5bG9hZDoge1xyXG4gICAgICAgICAgICAgIHBsdWdJZCxcclxuICAgICAgICAgICAgICBzdGF0ZSwgLy8gcmVxdWVzdGVkIHN0YXRlXHJcbiAgICAgICAgICAgICAgdXNlcklkLFxyXG4gICAgICAgICAgICAgIGNvb2xkb3duOiB7XHJcbiAgICAgICAgICAgICAgICBhY3RpdmU6IHRydWUsXHJcbiAgICAgICAgICAgICAgICByZXRyeUFmdGVyLFxyXG4gICAgICAgICAgICAgICAgbmV4dEFsbG93ZWRBdDogbm93U2Vjb25kcyArIHJldHJ5QWZ0ZXIsXHJcbiAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICBzdGF0dXM6IDQyOSxcclxuICAgICAgICAgICAgICBtZXNzYWdlOiBgQ29vbGRvd24gYWN0aXZlLiBQbGVhc2Ugd2FpdCAke3JldHJ5QWZ0ZXJ9IHNlY29uZHMuYCxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJXUyBicm9hZGNhc3QgKGNvb2xkb3duKSBmYWlsZWQ6XCIsIGUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGpzb25SZXNwb25zZShcclxuICAgICAgICAgIDQyOSxcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgbWVzc2FnZTogYENvb2xkb3duIGFjdGl2ZS4gUGxlYXNlIHdhaXQgJHtyZXRyeUFmdGVyfSBzZWNvbmRzLmAsXHJcbiAgICAgICAgICAgIHJldHJ5QWZ0ZXIsXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgeyBcIlJldHJ5LUFmdGVyXCI6IHJldHJ5QWZ0ZXIudG9TdHJpbmcoKSB9XHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgFxyXG4gICAgLy8gNCkgQ2FsbCBWb2ljZSBNb25rZXlcclxuICAgIC8vIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgFxyXG4gICAgY29uc3QgdXJsID0gbmV3IFVSTChWT0lDRV9NT05LRVlfQkFTRV9VUkwpO1xyXG4gICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoXCJ0b2tlblwiLCBWT0lDRV9NT05LRVlfVE9LRU4pO1xyXG4gICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoXCJkZXZpY2VcIiwgZGV2aWNlSWQpO1xyXG5cclxuICAgIGNvbnN0IHZtUmVzID0gYXdhaXQgZmV0Y2godXJsLnRvU3RyaW5nKCksIHtcclxuICAgICAgbWV0aG9kOiBcIkdFVFwiLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3Qgdm1UZXh0ID0gYXdhaXQgdm1SZXMudGV4dCgpO1xyXG4gICAgaWYgKCF2bVJlcy5vaykge1xyXG4gICAgICBjb25zb2xlLmVycm9yKFwiVm9pY2UgTW9ua2V5IGVycm9yOlwiLCB2bVJlcy5zdGF0dXMsIHZtVGV4dCk7XHJcbiAgICAgIHJldHVybiBqc29uUmVzcG9uc2UoNTAyLCB7XHJcbiAgICAgICAgbWVzc2FnZTogXCJGYWlsZWQgdG8gdHJpZ2dlciBWb2ljZSBNb25rZXlcIixcclxuICAgICAgICBzdGF0dXM6IHZtUmVzLnN0YXR1cyxcclxuICAgICAgICByZXNwb25zZTogdm1UZXh0LFxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIBcclxuICAgIC8vIDUpIExvZyB0byBEeW5hbW9EQlxyXG4gICAgLy8g4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAXHJcbiAgICBjb25zdCBwdXQgPSBuZXcgUHV0SXRlbUNvbW1hbmQoe1xyXG4gICAgICBUYWJsZU5hbWU6IFRBQkxFX05BTUUsXHJcbiAgICAgIEl0ZW06IHtcclxuICAgICAgICB1c2VyX2lkOiB7IFM6IHVzZXJJZCB9LFxyXG4gICAgICAgIHRzOiB7IE46IG5vd1NlY29uZHMudG9TdHJpbmcoKSB9LFxyXG4gICAgICAgIHBsdWdfaWQ6IHsgUzogcGx1Z0lkIH0sXHJcbiAgICAgICAgYWN0aW9uOiB7IFM6IHN0YXRlIH0sXHJcbiAgICAgICAgdm1fZGV2aWNlOiB7IFM6IGRldmljZUlkIH0sXHJcbiAgICAgICAgdm1fcmVzcG9uc2U6IHsgUzogdm1UZXh0LnNsaWNlKDAsIDUwMCkgfSwgLy8gdHJ1bmNhdGUgaWYgdG9vIGxvbmdcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG5cclxuICAgIGF3YWl0IGRkYi5zZW5kKHB1dCk7XHJcblxyXG4gICAgY29uc3QgcmVzcG9uc2VCb2R5ID0ge1xyXG4gICAgICBvazogdHJ1ZSxcclxuICAgICAgcGx1Z0lkLFxyXG4gICAgICBzdGF0ZSxcclxuICAgICAgdm1SZXNwb25zZTogdm1UZXh0LFxyXG4gICAgICBuZXh0QWxsb3dlZEF0OiBub3dTZWNvbmRzICsgQ09PTERPV05fU0VDT05EUyxcclxuICAgIH07XHJcblxyXG4gICAgLy8g4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAXHJcbiAgICAvLyA2KSBCcm9hZGNhc3Qgc3VjY2Vzc2Z1bCBhY3Rpb24gb3ZlciBXZWJTb2NrZXRcclxuICAgIC8vIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgFxyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgYnJvYWRjYXN0VG9BbGwoe1xyXG4gICAgICAgIHR5cGU6IFwicGx1Z19hY3Rpb25cIixcclxuICAgICAgICBzb3VyY2U6IFwicGx1Zy1jb250cm9sXCIsXHJcbiAgICAgICAgdHM6IG5vd1NlY29uZHMsXHJcbiAgICAgICAgcGF5bG9hZDoge1xyXG4gICAgICAgICAgcGx1Z0lkLFxyXG4gICAgICAgICAgc3RhdGUsXHJcbiAgICAgICAgICB1c2VySWQsXHJcbiAgICAgICAgICBjb29sZG93bjoge1xyXG4gICAgICAgICAgICBhY3RpdmU6IGZhbHNlLFxyXG4gICAgICAgICAgICBuZXh0QWxsb3dlZEF0OiBub3dTZWNvbmRzICsgQ09PTERPV05fU0VDT05EUyxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBzdGF0dXM6IDIwMCxcclxuICAgICAgICAgIG1lc3NhZ2U6IFwiUGx1ZyBhY3Rpb24gYWNjZXB0ZWRcIixcclxuICAgICAgICB9LFxyXG4gICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgY29uc29sZS5lcnJvcihcIldTIGJyb2FkY2FzdCAoc3VjY2VzcykgZmFpbGVkOlwiLCBlKTtcclxuICAgICAgLy8gZG9uJ3QgY2hhbmdlIEhUVFAgcmVzdWx0XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGpzb25SZXNwb25zZSgyMDAsIHJlc3BvbnNlQm9keSk7XHJcbiAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCJVbmV4cGVjdGVkIGVycm9yOlwiLCBlcnIpO1xyXG4gICAgcmV0dXJuIGpzb25SZXNwb25zZSg1MDAsIHsgbWVzc2FnZTogXCJJbnRlcm5hbCBzZXJ2ZXIgZXJyb3JcIiB9KTtcclxuICB9XHJcbn07XHJcbiJdfQ==